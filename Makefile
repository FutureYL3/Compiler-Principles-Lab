# ------------------------------------------------------------
#  编译器及参数
# ------------------------------------------------------------
CXX      := g++
CXXFLAGS := -std=c++17 -Wall -O2 -Iinclude      # 头文件目录

# ------------------------------------------------------------
#  源文件列表
# ------------------------------------------------------------
SRCS_TOP := $(wildcard *.cpp)                   # 根目录
SRCS_DIR := $(shell find src -name '*.cpp')     # 所有 src 下的
SRCS     := $(SRCS_TOP) $(SRCS_DIR)

# ------------------------------------------------------------
#  build 目录下的目标文件（保持层次）
# ------------------------------------------------------------
BUILDDIR := build
OBJS     := $(addprefix $(BUILDDIR)/,$(SRCS:.cpp=.o))

# ------------------------------------------------------------
#  可执行文件
# ------------------------------------------------------------
TARGET := $(BUILDDIR)/compiler

# ------------------------------------------------------------
#  头文件依赖（按实际路径写）
# ------------------------------------------------------------
DEPS := include/lexer/token.h include/lexer/lexer.h

# ------------------------------------------------------------
#  默认目标
# ------------------------------------------------------------
.PHONY: all
all: $(TARGET)

# ------------------ 链接 ------------------
$(TARGET): $(OBJS)
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) $^ -o $@

# ------------------ 编译 ------------------
$(BUILDDIR)/%.o: %.cpp $(DEPS)
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# ------------------ 清理 ------------------
.PHONY: clean
clean:
	rm -rf $(BUILDDIR)
